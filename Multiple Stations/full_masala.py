import csv
from datetime import datetime
import openmeteo_requests
import requests
import requests_cache
import pandas as pd
from retry_requests import retry

# Setup Indian Railways API key and base URL
API_KEY = '4ca75cf9c1cb385e61c3a856ae817766'
BASE_URL = f"http://indianrailapi.com/api/v2/StationCodeToName/apikey/{API_KEY}/StationCode/"

# File path for station data
stations_file_path = "stations.xls"

def fetch_station_details_from_api(station_code):
    """Fetch station details from the Indian Railway API."""
    url = BASE_URL + station_code
    try:
        response = requests.get(url)
        response.raise_for_status()
        data = response.json()
        if data['ResponseCode'] == "200" and data['Status'] == "SUCCESS":
            latitude = data['Station']['Latitude']
            longitude = data['Station']['Longitude']
            return {
                "label": station_code,
                "latitude": float(latitude) if latitude else None,
                "longitude": float(longitude) if longitude else None
            }
        else:
            return None
    except Exception as e:
        print(f"Error fetching details for station '{station_code}' from API: {e}")
        return None

def fetch_station_details(station_code, station_data):
    """Fetch station details with priority: Excel file > API > Manual Input."""
    if station_code in station_data:
        # Fetch from Excel file
        print(f"Found station '{station_code}' in the Excel file.")
        return {
            "label": station_code,
            "latitude": station_data[station_code]["Longitude"],
            "longitude": station_data[station_code]["Latitude"]
        }
    else:
        # Fetch from API
        print(f"Station '{station_code}' not found in Excel file. Querying API...")
        station_details = fetch_station_details_from_api(station_code)
        if station_details:
            print(f"Found station '{station_code}' in API.")
            return station_details
        else:
            # Prompt for manual input
            print(f"Station '{station_code}' not found in API. Please enter details manually.")
            try:
                latitude = float(input(f"Enter latitude for station '{station_code}': "))
                longitude = float(input(f"Enter longitude for station '{station_code}': "))
                return {"label": station_code, "latitude": latitude, "longitude": longitude}
            except ValueError:
                print(f"Invalid input for station '{station_code}'. Skipping it.")
                return None

# Read station data from Excel file
stations_df = pd.read_excel(stations_file_path)
stations_df = stations_df.drop_duplicates(subset="StationCode", keep="first")
station_data = stations_df.set_index("StationCode")[["Latitude", "Longitude"]].to_dict("index")

# List of station codes
station_codes = ['TK', 'KIAT', 'HHL', 'DBS', 'NDV', 'MDLL', 'DBL', 'BNKH', 'GHL', 'SDVL', 'BAW', 'YPR', 'MWM', 'SBC']

stations = []

for station_code in station_codes:
    station_details = fetch_station_details(station_code, station_data)
    if station_details:
        stations.append(station_details)

# Save updated station details
stations_df_output = pd.DataFrame(stations)
stations_df_output.to_excel("updated_stations.xlsx", index=False)
print("Updated station details saved to 'updated_stations.xlsx'.")

# Set up Open-Meteo API client with cache and retry on error
cache_session = requests_cache.CachedSession('.cache', expire_after=-1)
retry_session = retry(cache_session, retries=5, backoff_factor=0.2)
openmeteo = openmeteo_requests.Client(session=retry_session)

# Prepare weather data
data = [
    [datetime(2023,12,23),6,6,19,17,19,16,19,16,19,19,22,31,29,14]
,[datetime(2023,12,24),0,0,2,0,3,0,5,0,5,0,6,17,15,11]
,[datetime(2023,12,25),0,0,1,0,3,0,4,0,3,3,2,6,4,-9]
,[datetime(2023,12,26),0,0,2,0,2,0,2,0,0,0,1,9,7,-4]
,[datetime(2023,12,27),0,0,1,0,16,13,15,12,13,11,13,12,10,-8]
,[datetime(2023,12,28),0,0,1,0,2,0,4,0,1,0,4,3,0,-6]
,[datetime(2023,12,29),0,0,3,3,4,0,5,0,5,0,6,15,13,2]
,[datetime(2023,12,30),0,0,7,5,9,6,9,6,8,8,7,10,8,-5]
,[datetime(2023,12,31),0,0,5,5,3,0,6,3,6,6,12,18,16,0]
,[datetime(2024,1,1),0,0,7,7,8,3,9,6,11,11,11,12,10,-6]
,[datetime(2024,1,2),0,0,1,0,3,0,1,0,2,0,4,3,0,-16]
,[datetime(2024,1,3),0,0,1,0,1,0,2,0,1,0,3,4,2,-8]
,[datetime(2024,1,4),0,0,2,0,4,0,3,0,5,5,6,8,6,-7]
,[datetime(2024,1,5),0,0,2,0,2,0,4,0,0,0,2,0,0,9]
,[datetime(2024,1,6),0,0,0,0,1,0,0,0,0,0,1,7,5,-13]
,[datetime(2024,1,7),0,0,2,0,4,0,3,0,2,0,5,15,13,-5]
,[datetime(2024,1,8),0,0,0,0,1,0,1,0,0,0,0,0,0,-10]
,[datetime(2024,1,9),0,0,1,0,0,0,0,0,0,0,1,0,0,2]
,[datetime(2024,1,10),0,0,1,0,1,0,2,0,0,0,1,3,0,-14]
,[datetime(2024,1,11),0,0,1,0,1,0,1,0,0,0,11,13,11,-4]
,[datetime(2024,1,12),0,0,0,0,1,0,3,0,2,0,5,4,0,-13]
,[datetime(2024,1,13),0,0,3,3,6,3,6,3,3,3,8,4,2,-13]
,[datetime(2024,1,14),0,0,0,0,0,0,0,0,0,0,16,17,15,-3]
,[datetime(2024,1,15),0,0,4,0,5,0,8,5,8,8,17,19,17,5]
,[datetime(2024,1,16),16,16,15,15,15,11,14,11,11,10,11,16,14,-4]
,[datetime(2024,1,17),0,0,6,4,6,3,11,8,12,12,11,4,2,5]
,[datetime(2024,1,18),0,0,1,0,1,0,3,0,3,3,4,9,7,-9]
,[datetime(2024,1,19),0,0,1,0,1,0,1,0,3,3,16,15,13,2]
,[datetime(2024,1,20),0,0,3,3,6,3,8,5,8,8,11,12,10,-8]
,[datetime(2024,1,21),0,0,1,0,1,0,2,0,1,0,3,12,10,-7]
,[datetime(2024,1,22),0,0,2,0,2,0,2,0,0,0,2,7,5,-10]
,[datetime(2024,1,23),0,0,2,0,3,0,8,5,4,4,2,0,0,-19]
,[datetime(2024,1,24),0,0,2,0,2,0,1,0,0,0,1,6,4,-2]
,[datetime(2024,1,25),0,0,2,0,0,0,1,0,0,0,1,6,4,-8]
,[datetime(2024,1,26),0,0,7,7,9,6,11,7,11,9,12,15,13,-5]
,[datetime(2024,1,27),0,0,2,0,4,0,4,0,4,4,7,19,17,1]
,[datetime(2024,1,28),0,0,2,0,3,0,8,5,8,8,13,12,10,-1]
,[datetime(2024,1,29),0,0,2,0,4,0,4,0,3,3,4,12,10,-8]
,[datetime(2024,1,30),0,0,1,0,0,0,1,0,1,0,1,4,2,-10]
,[datetime(2024,1,31),0,0,4,4,1,0,7,4,9,9,9,22,20,3]
,[datetime(2024,2,1),30,30,32,32,32,0,31,28,28,27,28,23,21,10]
,[datetime(2024,2,2),0,0,7,7,10,7,11,8,11,11,11,9,6,2]
,[datetime(2024,2,3),0,0,0,0,4,0,4,0,4,4,8,7,5,-9]
,[datetime(2024,2,4),0,0,3,3,4,0,3,0,8,8,8,20,18,1]
,[datetime(2024,2,5),15,15,24,24,25,20,25,22,24,24,24,29,27,13]
,[datetime(2024,2,6),0,0,2,0,2,0,3,0,3,3,5,0,0,-6]
,[datetime(2024,2,7),0,0,4,4,1,0,1,0,1,0,8,11,9,-9]
,[datetime(2024,2,8),0,0,3,3,3,0,3,0,0,0,5,7,5,-11]
,[datetime(2024,2,9),20,20,19,19,18,15,13,10,9,9,9,8,6,12]
,[datetime(2024,2,10),20,20,24,24,26,23,27,25,21,21,20,22,19,13]
,[datetime(2024,2,11),0,0,2,0,4,0,5,0,5,0,4,2,0,-5]
,[datetime(2024,2,12),0,0,1,0,0,0,1,0,1,0,2,1,0,-18]
,[datetime(2024,2,13),0,0,0,0,2,0,3,0,4,0,6,2,0,-11]
,[datetime(2024,2,14),0,0,0,0,1,0,1,0,1,0,2,4,2,-10]
,[datetime(2024,2,15),0,0,3,3,6,3,8,5,6,4,8,11,9,11]
,[datetime(2024,2,16),0,0,0,0,0,0,0,0,0,0,0,11,9,14]
,[datetime(2024,2,17),0,0,2,0,2,0,3,0,1,0,3,9,7,-10]
,[datetime(2024,2,18),0,0,8,8,8,4,14,11,16,15,18,22,20,2]
,[datetime(2024,2,19),0,0,2,0,5,0,6,3,6,6,6,9,7,-9]
,[datetime(2024,2,20),0,0,3,0,3,0,5,0,5,5,20,19,17,0]
,[datetime(2024,2,21),0,0,1,0,1,0,0,0,0,0,0,1,0,-18]
,[datetime(2024,2,22),10,10,14,14,17,14,18,15,18,0,21,23,21,3]
,[datetime(2024,2,23),5,5,8,8,8,4,11,8,11,11,16,11,9,10]
,[datetime(2024,2,24),0,0,3,3,6,3,5,0,4,4,8,6,3,3]
,[datetime(2024,2,25),0,0,1,0,1,0,2,0,1,0,2,26,24,6]
,[datetime(2024,2,26),25,25,24,24,23,20,19,15,15,14,14,10,0,-5]
,[datetime(2024,2,27),0,0,2,0,3,0,1,0,0,0,0,0,0,-18]
,[datetime(2024,2,28),0,0,4,4,7,4,8,5,6,4,6,12,9,-2]
,[datetime(2024,2,29),0,0,0,0,4,0,6,3,0,0,6,8,6,-11]
,[datetime(2024,3,1),0,0,5,3,11,0,15,11,15,15,16,16,13,8]
,[datetime(2024,3,2),0,0,3,3,5,0,6,3,10,10,16,12,11,-6]
,[datetime(2024,3,3),0,0,2,0,2,0,3,0,1,0,1,3,0,0]
,[datetime(2024,3,4),0,0,2,0,2,0,3,0,0,0,0,12,10,-8]
,[datetime(2024,3,5),0,0,2,0,1,0,2,0,0,0,0,19,17,1]
,[datetime(2024,3,6),0,0,1,0,2,0,2,0,3,3,3,8,6,-9]
,[datetime(2024,3,7),0,0,3,3,3,0,3,0,4,4,4,14,12,-6]
,[datetime(2024,3,8),0,0,2,0,1,0,1,0,0,0,4,13,11,-7]
,[datetime(2024,3,9),0,0,3,3,5,0,4,0,4,4,7,8,6,-11]
,[datetime(2024,3,10),0,0,14,14,16,13,18,15,18,18,20,12,10,3]
,[datetime(2024,3,11),0,0,5,4,10,7,11,8,10,10,11,16,14,-1]
,[datetime(2024,3,12),0,0,6,6,6,3,8,5,8,8,11,15,13,-5]
,[datetime(2024,3,13),0,0,2,0,4,0,6,0,6,6,8,9,6,-8]
,[datetime(2024,3,14),20,20,24,24,26,23,26,23,23,22,23,18,16,7]
,[datetime(2024,3,15),0,0,1,0,1,0,6,3,5,5,6,7,5,-5]
,[datetime(2024,3,16),0,0,1,0,8,5,8,6,5,5,6,10,8,-9]
,[datetime(2024,3,17),7,7,14,14,17,14,19,16,17,15,19,0,0,2]
,[datetime(2024,3,18),0,0,2,0,3,0,4,0,5,5,7,9,7,-9]
,[datetime(2024,3,19),0,0,0,0,2,0,2,0,0,0,0,1,0,-17]
,[datetime(2024,3,20),0,0,1,0,1,0,4,0,2,0,3,6,4,-3]
,[datetime(2024,3,21),1,0,3,3,5,0,2,0,2,0,4,11,9,-7]
,[datetime(2024,3,22),0,0,1,0,3,0,4,0,5,5,7,19,17,-1]
,[datetime(2024,3,23),0,0,3,3,5,0,8,5,10,10,11,13,11,-6]
,[datetime(2024,3,24),0,0,4,4,5,0,6,0,7,7,8,20,18,1]
,[datetime(2024,3,25),0,0,0,0,0,0,1,0,0,0,0,5,3,-10]
,[datetime(2024,3,26),0,0,1,0,2,0,4,0,4,4,5,12,10,-7]
,[datetime(2024,3,27),0,0,4,3,5,0,7,4,8,0,8,12,10,-7]
,[datetime(2024,3,28),0,0,2,0,5,0,4,0,4,0,5,7,5,-12]
,[datetime(2024,3,29),0,0,2,0,3,0,3,0,2,0,4,16,14,-3]
,[datetime(2024,3,30),0,0,3,0,3,0,2,0,0,0,0,1,0,-18]
,[datetime(2024,3,31),0,0,0,0,2,0,1,0,0,0,5,30,28,11]
,[datetime(2024,4,1),0,0,2,0,2,0,2,0,0,0,1,6,4,1]
,[datetime(2024,4,2),0,0,1,0,1,0,0,0,3,3,4,4,2,-15]
,[datetime(2024,4,3),0,0,3,3,1,0,1,0,2,0,1,4,2,-9]
,[datetime(2024,4,4),8,8,14,13,17,14,14,9,16,16,15,13,9,11]
,[datetime(2024,4,5),0,0,0,0,4,0,7,4,6,6,6,2,0,-1]
,[datetime(2024,4,6),0,0,6,6,4,0,2,0,0,0,9,9,6,-1]
,[datetime(2024,4,7),0,0,2,0,0,0,0,0,0,0,0,12,10,-6]
,[datetime(2024,4,8),0,0,9,9,11,8,11,8,11,11,11,12,8,0]
,[datetime(2024,4,9),0,0,1,0,3,0,2,0,1,0,1,0,0,-15]
,[datetime(2024,4,10),0,0,2,0,0,0,0,0,0,0,0,1,0,-20]
,[datetime(2024,4,11),0,0,1,0,2,0,1,0,0,0,1,6,4,-8]
,[datetime(2024,4,12),0,0,2,0,0,0,2,0,5,5,11,27,25,7]
,[datetime(2024,4,13),4,4,5,3,6,0,6,3,3,3,3,10,8,-10]
,[datetime(2024,4,14),0,0,2,0,2,0,1,0,0,0,3,0,0,-18]
,[datetime(2024,4,15),1,0,6,6,7,4,7,4,8,8,8,5,1,6]
,[datetime(2024,4,16),0,0,1,0,1,0,0,0,0,0,11,9,0,11]
,[datetime(2024,4,17),0,0,1,0,1,0,1,0,1,0,20,22,20,2]
,[datetime(2024,4,18),0,0,5,5,7,4,9,6,9,9,14,18,16,-1]
,[datetime(2024,4,19),0,0,0,0,0,0,0,0,0,0,6,17,15,-2]
,[datetime(2024,4,20),0,0,15,15,14,11,14,11,12,10,11,17,15,12]
,[datetime(2024,4,21),0,0,2,0,2,0,0,0,0,0,0,13,11,-6]
,[datetime(2024,4,22),0,0,3,3,3,0,3,0,1,0,2,14,12,-6]
,[datetime(2024,4,23),0,0,4,4,6,3,7,4,8,8,10,14,12,-1]
,[datetime(2024,4,24),0,0,4,4,5,0,3,0,1,0,4,8,6,-7]
,[datetime(2024,4,25),0,0,5,4,3,0,8,5,10,10,9,18,16,-3]
,[datetime(2024,4,26),0,0,5,5,5,0,7,4,2,3,1,13,11,-7]
,[datetime(2024,4,27),0,0,3,3,3,0,3,0,4,0,7,17,14,10]
,[datetime(2024,4,28),0,0,10,10,12,0,13,10,12,12,14,20,18,2]
,[datetime(2024,4,29),0,0,3,3,3,0,4,0,2,0,3,6,3,-13]
,[datetime(2024,4,30),0,0,1,0,0,0,0,0,0,0,5,0,0,-8]
,[datetime(2024,5,1),0,0,2,0,4,0,0,0,0,0,1,8,6,-11]
,[datetime(2024,5,2),0,0,8,8,11,8,11,8,10,10,12,17,15,-4]
,[datetime(2024,5,3),0,0,2,0,0,0,0,0,0,0,0,5,3,-14]
,[datetime(2024,5,4),10,10,17,17,20,17,21,18,17,17,19,17,15,6]
,[datetime(2024,5,5),0,0,7,7,10,7,9,0,8,8,8,12,10,-8]
,[datetime(2024,5,6),0,0,2,0,3,0,6,3,3,3,7,14,12,-5]
,[datetime(2024,5,7),0,0,1,0,5,0,6,3,5,5,6,12,10,-8]
,[datetime(2024,5,8),0,0,1,0,0,0,3,0,1,0,3,6,4,9]
,[datetime(2024,5,9),0,0,2,0,3,0,6,3,8,8,11,13,11,-7]
,[datetime(2024,5,10),0,0,3,3,4,0,0,0,5,0,6,11,9,-8]
,[datetime(2024,5,11),0,0,3,3,10,7,7,4,7,7,7,3,0,9]
,[datetime(2024,5,12),9,9,16,16,14,12,12,7,11,11,10,17,15,5]
,[datetime(2024,5,13),0,0,3,3,8,5,11,8,14,14,17,19,17,5]
,[datetime(2024,5,14),8,8,7,7,8,3,6,3,4,4,6,12,10,-9]
,[datetime(2024,5,15),0,0,4,3,4,0,6,3,2,0,3,3,0,-15]
,[datetime(2024,5,16),0,0,2,0,3,0,4,0,3,3,4,7,5,-8]
,[datetime(2024,5,17),0,0,1,0,0,0,5,0,5,5,5,3,0,-14]
,[datetime(2024,5,18),0,0,2,0,0,0,0,0,0,0,1,2,0,-18]
,[datetime(2024,5,19),0,0,2,0,2,0,2,0,2,0,6,17,15,10]
,[datetime(2024,5,20),0,0,19,18,21,17,20,18,16,17,15,10,8,12]
,[datetime(2024,5,21),0,0,1,0,1,0,2,0,2,0,4,8,6,-9]
,[datetime(2024,5,22),0,0,2,0,2,0,1,0,0,0,3,11,9,-4]
,[datetime(2024,5,23),0,0,1,0,0,0,1,0,1,0,9,14,12,-6]
,[datetime(2024,5,24),0,0,2,0,0,0,0,0,0,0,4,15,13,-3]
,[datetime(2024,5,25),0,0,5,4,7,4,11,8,9,7,11,36,34,16]
,[datetime(2024,5,26),0,0,2,0,2,0,4,0,5,3,18,17,15,-2]
,[datetime(2024,5,27),0,0,3,3,2,0,6,3,6,6,7,20,18,0]
,[datetime(2024,5,28),0,0,2,0,2,0,2,0,0,0,14,20,18,0]
,[datetime(2024,5,29),0,0,2,0,6,3,1,0,0,0,1,0,0,-12]
,[datetime(2024,5,30),0,0,2,0,2,0,4,0,2,0,2,6,4,-5]
,[datetime(2024,5,31),0,0,0,0,0,0,0,0,2,0,11,15,13,-5]
,[datetime(2024,6,1),0,0,3,3,6,3,10,7,5,6,4,14,12,-5]
,[datetime(2024,6,2),0,0,2,0,0,0,0,0,0,0,2,7,5,-10]
,[datetime(2024,6,3),20,20,24,24,25,20,27,24,38,38,40,44,42,24]
,[datetime(2024,6,4),0,0,2,0,7,4,8,5,17,17,24,23,21,5]
,[datetime(2024,6,5),0,0,3,3,3,0,7,4,12,0,12,21,19,6]
,[datetime(2024,6,6),None,None,None,None,None,None,None,None,0,0,20,19,17,1]
,[datetime(2024,6,7),0,0,3,3,5,0,4,0,2,0,3,19,17,-2]
,[datetime(2024,6,8),20,20,26,26,29,26,31,0,29,29,29,28,26,15]
,[datetime(2024,6,9),18,18,21,20,19,16,21,18,22,23,21,26,24,15]
,[datetime(2024,6,10),0,0,9,0,11,8,15,12,18,18,20,17,15,0]
,[datetime(2024,6,11),0,0,12,12,12,8,14,11,14,13,13,17,15,11]
,[datetime(2024,6,12),0,0,1,0,2,0,6,3,0,0,9,15,13,-6]
,[datetime(2024,6,13),None,None,None,None,None,None,None,None,7,7,7,14,12,-5]
,[datetime(2024,6,14),0,0,4,4,4,0,7,4,6,6,10,12,10,-5]
,[datetime(2024,6,15),0,0,2,0,2,0,5,0,3,3,6,22,20,2]
,[datetime(2024,6,16),19,19,22,22,21,18,26,23,24,22,27,27,24,14]
,[datetime(2024,6,17),0,0,9,9,16,0,22,19,22,0,21,28,26,10]
,[datetime(2024,6,18),0,0,5,4,6,3,6,3,3,3,5,9,7,-10]
,[datetime(2024,6,19),0,0,3,3,0,0,0,0,1,0,1,5,3,-15]
,[datetime(2024,6,20),26,26,30,30,30,26,29,26,26,25,25,23,20,14]
,[datetime(2024,6,21),0,0,19,19,22,19,20,17,17,16,20,18,16,13]
,[datetime(2024,6,22),12,12,16,16,22,19,24,21,23,23,22,19,17,12]
,[datetime(2024,6,23),0,0,0,0,0,0,2,0,1,0,3,5,3,-11]
,[datetime(2024,6,24),0,0,3,0,4,0,8,5,6,4,5,6,3,-11]
,[datetime(2024,6,25),0,0,1,0,3,0,5,0,4,4,7,8,6,-12]
,[datetime(2024,6,26),0,0,1,0,1,0,1,0,1,0,2,3,0,-14]
,[datetime(2024,6,27),0,0,9,9,8,5,11,8,12,12,13,16,14,-4]
,[datetime(2024,6,28),0,0,2,0,4,0,5,0,3,3,5,12,10,-3]
,[datetime(2024,6,29),0,0,1,0,6,0,5,0,15,15,19,25,23,12]
,[datetime(2024,6,30),0,0,4,4,5,0,7,4,7,7,12,24,22,8]
,[datetime(2024,7,1),0,0,2,0,2,0,4,0,3,3,3,7,5,-13]
,[datetime(2024,7,2),8,8,9,7,8,3,10,7,8,6,7,0,0,-1]
,[datetime(2024,7,3),0,0,2,0,3,0,3,0,1,0,3,7,5,-4]
,[datetime(2024,7,4),0,0,0,0,7,4,12,9,12,12,16,19,17,-2]
,[datetime(2024,7,5),0,0,5,5,8,0,9,6,11,11,15,21,19,12]
,[datetime(2024,7,6),20,20,25,25,26,21,19,16,25,25,24,18,17,8]
,[datetime(2024,7,7),0,0,7,7,9,6,10,7,10,0,10,21,19,2]
,[datetime(2024,7,8),0,0,8,8,8,4,7,4,8,8,11,10,8,-8]
,[datetime(2024,7,9),19,19,22,22,22,18,21,18,17,17,21,21,19,10]
,[datetime(2024,7,10),0,0,3,3,6,3,5,0,3,3,6,8,6,-4]
,[datetime(2024,7,11),16,16,18,0,18,15,18,15,14,14,15,10,8,10]
,[datetime(2024,7,12),0,0,5,5,7,4,8,5,10,10,14,15,13,-3]
,[datetime(2024,7,13),0,0,2,0,0,0,5,0,3,3,3,0,0,0]
,[datetime(2024,7,14),0,0,4,4,4,0,7,4,4,3,16,17,0,10]
,[datetime(2024,7,15),0,0,4,4,5,0,5,0,29,29,27,34,32,13]
,[datetime(2024,7,16),0,0,1,0,12,9,13,10,11,9,12,9,9,-1]
,[datetime(2024,7,17),0,0,4,4,5,0,5,0,3,3,4,4,0,-7]
,[datetime(2024,7,18),None,None,0,0,6,3,10,6,12,12,15,12,10,-5]
,[datetime(2024,7,19),0,0,7,7,8,3,8,5,6,4,8,15,13,-5]
,[datetime(2024,7,20),0,0,4,4,5,0,4,0,2,0,3,5,3,-13]
,[datetime(2024,7,21),0,0,5,3,4,0,4,0,6,6,8,11,9,-1]
,[datetime(2024,7,22),7,7,16,16,18,15,20,17,21,21,23,19,17,8]
,[datetime(2024,7,23),0,0,4,3,4,0,2,0,3,3,5,15,13,-3]
,[datetime(2024,7,24),0,0,7,7,7,3,8,5,3,4,5,19,17,0]
,[datetime(2024,7,25),None,None,0,0,1,0,1,0,0,0,0,1,0,-19]
,[datetime(2024,7,26),0,0,3,3,3,0,3,0,3,0,2,13,11,-7]
,[datetime(2024,7,27),0,0,5,5,5,0,7,4,4,3,6,16,14,0]
,[datetime(2024,7,28),0,0,5,5,6,3,6,3,6,7,8,28,26,10]
,[datetime(2024,7,29),0,0,5,5,4,0,5,0,4,4,5,9,7,-10]
,[datetime(2024,7,30),0,0,3,3,4,0,2,0,1,0,0,0,0,-19]
,[datetime(2024,7,31),0,0,4,3,7,0,7,4,5,3,6,12,10,-7]
,[datetime(2024,8,1),0,0,8,8,8,4,9,6,10,10,12,16,14,-3]
,[datetime(2024,8,2),0,0,3,0,6,3,7,4,9,9,11,19,17,1]
,[datetime(2024,8,3),0,0,3,0,3,0,5,0,5,5,18,22,20,3]
,[datetime(2024,8,4),0,0,4,4,4,0,3,0,2,0,3,14,12,-6]
,[datetime(2024,8,5),0,0,4,4,4,0,5,0,10,9,36,39,37,20]
,[datetime(2024,8,6),0,0,2,0,3,0,4,0,1,0,2,6,4,-14]
,[datetime(2024,8,7),0,0,4,3,8,5,8,5,10,10,13,19,17,0]
,[datetime(2024,8,8),0,0,2,0,6,3,6,3,8,8,9,3,1,-9]
,[datetime(2024,8,9),0,0,1,0,1,0,1,0,0,0,7,20,18,1]
,[datetime(2024,8,10),25,25,29,29,30,25,28,25,26,24,26,31,29,12]
,[datetime(2024,8,11),0,0,5,5,5,0,5,0,4,4,11,19,17,-2]
,[datetime(2024,8,12),0,0,6,5,7,4,9,6,8,8,11,13,11,-6]
,[datetime(2024,8,13),0,0,2,0,5,0,6,3,7,7,9,10,8,-9]
,[datetime(2024,8,14),18,18,23,23,23,19,22,19,18,18,18,29,27,10]
,[datetime(2024,8,15),0,0,3,3,4,0,3,0,2,0,0,10,8,-9]
,[datetime(2024,8,16),0,0,2,0,2,0,3,0,1,0,2,12,10,-7]
,[datetime(2024,8,17),2,0,5,3,10,7,16,13,18,16,19,21,19,3]
,[datetime(2024,8,18),0,0,3,3,6,3,7,4,8,8,11,29,27,13]
,[datetime(2024,8,19),15,15,21,21,21,0,21,18,18,17,25,31,29,13]
,[datetime(2024,8,20),0,0,1,0,0,0,1,0,0,0,2,4,0,-14]
,[datetime(2024,8,21),0,0,3,3,3,0,4,0,6,6,7,5,3,-1]
,[datetime(2024,8,22),0,0,3,3,2,0,4,0,4,4,3,9,7,-8]
,[datetime(2024,8,23),0,0,1,0,0,0,1,0,0,0,3,18,16,0]
,[datetime(2024,8,24),0,0,3,3,5,0,5,0,5,5,9,12,10,-7]
,[datetime(2024,8,25),0,0,5,5,7,0,9,6,9,9,14,11,11,2]
,[datetime(2024,8,26),0,0,4,3,7,4,7,4,8,8,10,15,13,-3]
,[datetime(2024,8,27),0,0,2,0,2,0,0,0,0,0,2,7,5,-12]
,[datetime(2024,8,28),0,0,2,0,2,0,2,0,2,0,12,14,12,-6]
,[datetime(2024,8,29),0,0,7,6,8,5,10,7,11,11,19,21,19,2]
,[datetime(2024,8,30),4,4,10,10,10,6,11,8,11,11,13,17,15,-2]
,[datetime(2024,8,31),0,0,3,3,4,0,2,0,2,0,5,7,5,-10]
,[datetime(2024,9,1),0,0,1,0,2,0,4,0,4,4,7,33,31,14]
,[datetime(2024,9,2),0,0,3,3,2,0,3,0,3,0,5,9,7,-10]
,[datetime(2024,9,3),0,0,5,5,11,8,14,11,18,0,21,29,27,10]
,[datetime(2024,9,4),0,0,1,0,1,0,3,0,1,0,11,18,16,-2]
,[datetime(2024,9,5),0,0,1,0,1,0,3,0,2,0,1,8,6,-10]
,[datetime(2024,9,6),0,0,3,3,3,0,6,3,5,5,7,22,20,3]
,[datetime(2024,9,7),0,0,2,0,3,0,6,3,6,6,7,9,7,-6]
,[datetime(2024,9,8),0,0,5,5,7,4,9,6,9,9,9,18,16,-1]
,[datetime(2024,9,9),0,0,3,3,5,0,6,3,6,6,8,15,13,-3]
,[datetime(2024,9,10),0,0,1,0,5,0,7,4,6,6,6,13,11,-7]
,[datetime(2024,9,11),0,0,0,0,0,0,3,0,0,0,0,3,0,-15]
,[datetime(2024,9,12),0,0,1,0,9,6,9,6,9,9,12,14,12,-6]
,[datetime(2024,9,13),0,0,3,3,2,0,2,0,2,0,2,11,9,-6]
,[datetime(2024,9,14),0,0,1,0,1,0,2,0,0,0,6,14,12,-6]
,[datetime(2024,9,15),0,0,1,0,1,0,2,0,0,0,1,17,15,-2]
,[datetime(2024,9,16),0,0,4,4,4,0,4,0,6,6,6,11,9,-6]
,[datetime(2024,9,17),0,0,3,3,5,0,6,3,5,5,8,10,8,-10]
,[datetime(2024,9,18),0,0,2,0,2,0,3,0,3,3,4,7,5,-10]
,[datetime(2024,9,19),0,0,4,4,7,4,10,7,10,10,15,21,19,2]
,[datetime(2024,9,20),0,0,4,3,8,5,9,6,7,8,8,15,13,-3]
,[datetime(2024,9,21),0,0,3,3,6,3,6,3,6,6,8,10,8,0]
,[datetime(2024,9,22),0,0,4,4,11,8,12,9,13,13,15,19,17,1]
,[datetime(2024,9,23),0,0,3,3,3,0,6,3,4,4,7,10,8,-8]
,[datetime(2024,9,24),26,26,29,29,30,25,30,27,28,26,28,25,23,21]
,[datetime(2024,9,25),0,0,3,3,7,4,8,5,9,9,11,11,9,-8]
,[datetime(2024,9,26),0,0,5,5,7,4,9,6,4,5,8,12,10,-4]
,[datetime(2024,9,27),0,0,3,0,3,0,5,0,4,0,5,17,15,-2]
,[datetime(2024,9,28),0,0,4,4,9,6,8,5,8,8,8,22,20,2]
,[datetime(2024,9,29),0,0,0,0,2,0,4,0,8,7,10,5,3,-5]
,[datetime(2024,9,30),0,0,2,0,5,0,4,0,3,3,7,12,10,-5]
,[datetime(2024,10,1),0,0,2,0,2,0,4,0,2,0,1,2,0,-17]
,[datetime(2024,10,2),0,0,5,5,9,6,11,8,12,12,16,24,22,6]
,[datetime(2024,10,3),0,0,3,3,4,0,6,3,8,0,9,8,6,-10]
,[datetime(2024,10,4),0,0,3,3,6,3,7,4,7,7,9,11,9,-7]
,[datetime(2024,10,5),0,0,3,3,8,5,11,8,11,11,13,18,16,-1]
,[datetime(2024,10,6),0,0,3,3,9,6,9,6,10,9,12,19,17,1]
,[datetime(2024,10,7),0,0,2,0,4,0,8,5,10,10,13,18,16,-2]
,[datetime(2024,10,8),0,0,0,0,1,0,1,0,0,0,8,20,18,0]
,[datetime(2024,10,9),0,0,2,0,3,0,6,3,5,5,8,8,5,-6]
,[datetime(2024,10,10),0,0,1,0,1,0,2,0,1,0,4,21,19,3]
,[datetime(2024,10,11),0,0,2,0,2,0,3,0,3,3,6,27,25,7]
,[datetime(2024,10,12),0,0,6,6,7,0,7,4,7,7,10,8,6,-7]
,[datetime(2024,10,13),0,0,6,6,6,3,8,5,7,7,9,11,9,-8]
,[datetime(2024,10,14),0,0,2,0,3,0,7,4,3,3,6,9,7,-5]
,[datetime(2024,10,15),8,8,17,17,28,24,31,28,32,32,40,41,39,23]
,[datetime(2024,10,16),0,0,2,0,7,4,9,6,8,8,12,11,9,-9]
,[datetime(2024,10,17),26,26,30,28,32,29,34,31,34,34,39,38,36,18]
,[datetime(2024,10,18),0,0,2,0,5,0,6,3,5,5,8,9,7,-9]
,[datetime(2024,10,19),0,0,4,4,8,5,9,6,9,9,9,12,10,-8]
,[datetime(2024,10,20),0,0,3,3,4,0,7,4,3,3,9,16,14,-4]
,[datetime(2024,10,21),0,0,2,0,4,0,4,0,1,0,3,3,0,-16]
,[datetime(2024,10,22),0,0,1,0,3,0,3,0,1,0,3,20,18,2]
,[datetime(2024,10,23),0,0,1,0,4,0,6,3,5,5,5,11,9,-6]
,[datetime(2024,10,24),0,0,1,0,1,0,5,0,5,5,6,29,27,10]
,[datetime(2024,10,25),0,0,0,0,1,0,1,0,2,0,4,15,13,-1]
,[datetime(2024,10,26),16,16,21,19,25,22,26,0,26,26,28,29,27,11]
,[datetime(2024,10,27),0,0,1,0,3,0,1,0,1,0,2,10,8,-7]
,[datetime(2024,10,28),0,0,2,0,2,0,3,0,0,0,4,4,0,-15]
,[datetime(2024,10,29),0,0,1,0,3,0,3,0,2,0,10,16,14,-3]
,[datetime(2024,10,30),0,0,1,0,2,0,2,0,2,0,1,4,0,-9]
,[datetime(2024,10,31),0,0,2,0,3,0,5,0,6,6,6,14,12,-6]
,[datetime(2024,11,1),0,0,2,0,2,0,1,0,0,0,1,11,9,-6]
,[datetime(2024,11,2),0,0,0,0,0,0,0,0,0,0,0,19,17,2]
,[datetime(2024,11,3),0,0,1,0,2,0,8,5,9,9,11,16,14,-1]
,[datetime(2024,11,4),0,0,2,0,3,0,6,3,6,6,7,9,7,-9]
,[datetime(2024,11,5),0,0,5,5,7,4,8,5,8,8,11,13,11,-7]
,[datetime(2024,11,6),0,0,0,0,1,0,2,0,2,0,3,10,8,-8]
,[datetime(2024,11,7),5,5,11,11,12,7,13,10,11,9,11,15,13,-3]
,[datetime(2024,11,8),0,0,20,20,19,16,16,11,15,15,19,28,26,11]
,[datetime(2024,11,9),0,0,3,3,5,0,7,4,3,3,10,13,11,-7]
,[datetime(2024,11,10),0,0,2,0,4,0,4,0,5,5,5,20,18,3]
,[datetime(2024,11,11),2,0,5,3,8,5,11,0,10,10,21,29,27,10]
,[datetime(2024,11,12),0,0,17,17,18,13,20,17,20,20,22,26,24,6]
,[datetime(2024,11,13),0,0,1,0,4,0,7,4,6,6,6,16,14,-4]
,[datetime(2024,11,14),0,0,1,0,0,0,1,0,0,0,0,6,4,-14]
,[datetime(2024,11,15),0,0,4,0,7,4,9,6,10,10,13,17,15,0]
,[datetime(2024,11,16),0,0,3,3,4,0,6,3,8,8,9,13,11,-5]
,[datetime(2024,11,17),0,0,2,0,2,0,3,0,1,0,1,13,11,-6]
,[datetime(2024,11,18),0,0,5,5,5,0,4,0,2,0,4,11,9,-8]
,[datetime(2024,11,19),0,0,1,0,3,0,5,0,4,4,7,7,5,-13]
,[datetime(2024,11,20),0,0,2,0,7,4,10,0,10,10,10,12,10,-7]
,[datetime(2024,11,21),0,0,2,0,2,0,3,0,2,0,2,6,4,-13]
,[datetime(2024,11,22),0,0,3,3,2,0,3,0,3,3,4,22,20,2]
,[datetime(2024,11,23),None,None,None,None,None,None,0,0,2,0,4,0,0,-9]
,[datetime(2024,11,24),0,0,3,3,10,7,11,8,12,12,14,18,16,0]
,[datetime(2024,11,25),0,0,2,0,2,0,4,0,2,0,5,8,6,-9]
,[datetime(2024,11,26),0,0,1,0,1,0,3,0,2,0,3,6,4,-10]
,[datetime(2024,11,27),0,0,1,0,3,0,3,0,2,0,3,4,0,-15]
,[datetime(2024,11,28),0,0,2,0,11,8,12,9,12,11,16,21,19,0]
,[datetime(2024,11,29),0,0,1,0,3,0,2,0,0,0,0,14,12,-4]
,[datetime(2024,11,30),0,0,0,0,4,0,4,0,4,4,5,5,3,-14]
,[datetime(2024,12,1),0,0,2,0,3,0,1,0,1,0,5,26,24,8]
,[datetime(2024,12,2),0,0,4,4,4,0,5,0,6,6,6,10,8,-8]
,[datetime(2024,12,3),0,0,1,0,3,0,6,3,6,6,9,10,8,-10]
,[datetime(2024,12,4),0,0,4,3,6,3,7,4,7,7,6,7,5,-5]
,[datetime(2024,12,5),0,0,3,3,3,0,3,0,3,3,3,5,3,-14]
,[datetime(2024,12,6),0,0,3,3,5,0,6,3,4,4,6,1,0,-6]
,[datetime(2024,12,7),0,0,1,0,2,0,3,0,2,0,1,1,0,-17]
,[datetime(2024,12,8),0,0,1,0,1,0,2,0,4,4,8,20,18,6]
,[datetime(2024,12,9),0,0,2,0,3,0,4,0,2,0,9,7,5,-6]
,[datetime(2024,12,10),0,0,2,0,2,0,2,0,0,0,1,0,0,-13]
,[datetime(2024,12,11),0,0,0,0,2,0,4,0,3,3,4,12,10,-9]
,[datetime(2024,12,12),3,3,11,11,11,7,13,10,16,16,19,24,22,4]
,[datetime(2024,12,13),0,0,3,0,4,0,5,0,5,5,5,10,8,-8]
,[datetime(2024,12,14),0,0,2,0,4,0,5,0,4,4,6,2,0,-10]
,[datetime(2024,12,15),0,0,0,0,0,0,0,0,0,0,0,26,24,7]
,[datetime(2024,12,16),0,0,1,0,6,3,8,5,8,8,11,12,10,-7]
,[datetime(2024,12,17),0,0,2,0,6,0,9,6,8,8,15,16,14,-4]
,[datetime(2024,12,18),0,0,0,0,3,0,1,0,1,0,1,17,15,-2]
,[datetime(2024,12,19),0,0,7,5,7,3,9,6,8,8,12,11,9,-8]
,[datetime(2024,12,20),0,0,0,0,3,0,3,0,3,3,6,10,8,-8]
,[datetime(2024,12,21),0,0,6,6,7,4,8,5,9,9,9,11,9,-8]
    # Add more rows as needed
]

# Prepare the initial table with just dates and delays
dates = [row[0].strftime('%d/%m/%y') for row in data]
df = pd.DataFrame({"Date": dates})

# Add delay data for each station in the format specified
for i, station in enumerate(stations):
    df[station["label"]] = [row[i + 1] for row in data]

# Fetch and merge weather data for each station
for station in stations:
    url = "https://archive-api.open-meteo.com/v1/archive"
    params = {
        "latitude": station["longitude"],
        "longitude": station["latitude"],
        "start_date": "2023-12-23",
        "end_date": "2024-12-21",
        "daily": ["weather_code", "temperature_2m_mean", "wind_speed_10m_max"]
    }

    # Fetch data from Open-Meteo API
    try:
        response = openmeteo.weather_api(url, params=params)[0]
        print(response)
        daily = response.Daily()
        dates = pd.date_range(
            start=pd.to_datetime(daily.Time(), unit="s", utc=True),
            end=pd.to_datetime(daily.TimeEnd(), unit="s", utc=True),
            freq=pd.Timedelta(seconds=daily.Interval()),
            inclusive="left"
        )

        # Ensure dates is a list, matching the length of weather data variables
        dates = list(dates)
        weather_code = daily.Variables(0).ValuesAsNumpy()
        temperature = daily.Variables(1).ValuesAsNumpy()
        wind_speed = daily.Variables(2).ValuesAsNumpy()

        # Create a temporary DataFrame to store the data for this station
        temp_df = pd.DataFrame({
            "Date": [date.strftime('%d/%m/%y') for date in dates],
            f"{station['label']}_Delay": df[station["label"]].values,
            f"weather_code_{station['label']}": weather_code,
            f"Temperature_{station['label']}": temperature,
            f"Wind_Speed_{station['label']}": wind_speed,
            f"Distance_travelled_{station['label']}": [None] * len(weather_code)  # Placeholder for Distance
        })

        # Merge this station's data back into the main DataFrame
        df = df.merge(temp_df, on="Date", how="left")
    except Exception as e:
        print(f"Error fetching data for station '{station['label']}': {e}")

# Drop the original delay columns used for initialization
df.drop(columns=[station["label"] for station in stations], inplace=True)

# Save final table with delays and weather details
df.to_csv("06572(14).csv", index=False)
print("Data has been formatted and saved to 'merged_train_weather_data.csv'.")
